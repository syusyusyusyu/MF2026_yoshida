# ğŸ”Œ 5. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä»•æ§˜æ›¸

## 5.1 API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (Cloudflare Workers)

### ğŸ“¥ ã‚¹ã‚³ã‚¢ç™»éŒ² API
**POST** `/api/score`

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
| :--- | :--- | :--- | :--- | :--- |
| `playerName` | string | âœ… | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å | æœ€å¤§20æ–‡å­—ã€åˆ¶å¾¡æ–‡å­—é™¤å¤– |
| `songId` | string | âœ… | æ¥½æ›²ID | åŠè§’è‹±æ•°è¨˜å·ã®ã¿ |
| `mode` | string | âœ… | ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ | cursor, body, mobile, hand |
| `score` | number | âœ… | ã‚¹ã‚³ã‚¢ | 0ä»¥ä¸Šæ•´æ•° |
| `maxCombo` | number | âœ… | æœ€å¤§ã‚³ãƒ³ãƒœ | 0ä»¥ä¸Šæ•´æ•° |
| `rank` | string | âœ… | è©•ä¾¡ãƒ©ãƒ³ã‚¯ | S, A, B... |
| `turnstileToken`| string | - | èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ | Turnstileé€£æºç”¨ |

**ãƒ˜ãƒƒãƒ€ãƒ¼**: `x-score-token` (å¿…é ˆ) - HMACç½²åãƒˆãƒ¼ã‚¯ãƒ³

---

### ğŸ“¤ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾— API
**GET** `/api/ranking`

| ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
| :--- | :--- | :--- | :--- |
| `songId` | string | - | å¯¾è±¡ã®æ¥½æ›²ID (å¿…é ˆ) |
| `mode` | string | - | ç‰¹å®šãƒ¢ãƒ¼ãƒ‰ã®ã¿æŠ½å‡º (ä»»æ„) |
| `period` | string | `all` | `all`(å…¨æœŸé–“), `weekly`, `daily` |
| `limit` | number | `20` | å–å¾—ä»¶æ•° (æœ€å¤§50) |

---

## 5.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ (Supabase)

**ãƒ†ãƒ¼ãƒ–ãƒ«**: `public.scores`

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | åˆ¶ç´„ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
| :--- | :--- | :--- | :--- |
| `id` | uuid | PK, `gen_random_uuid()` | ãƒ¬ã‚³ãƒ¼ãƒ‰ID |
| `session_id` | text | not null | ãƒ–ãƒ©ã‚¦ã‚¶ã‚»ãƒƒã‚·ãƒ§ãƒ³ID |
| `song_id` | text | not null | æ¥½æ›²è­˜åˆ¥å­ |
| `mode` | text | check (...) | ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ |
| `score` | integer | not null | ç²å¾—ã‚¹ã‚³ã‚¢ |
| `max_combo` | integer | not null | æœ€å¤§ã‚³ãƒ³ãƒœæ•° |
| `rank` | text | not null | ã‚¯ãƒªã‚¢ãƒ©ãƒ³ã‚¯ |
| `is_suspicious`| boolean | `false` | ãƒãƒ¼ãƒˆç–‘æƒ‘ãƒ•ãƒ©ã‚° |
| `created_at` | timestamp | `now()` | ãƒ—ãƒ¬ã‚¤æ—¥æ™‚ |